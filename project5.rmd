```{r}
#read data
info <- read.table('lt1720uk.dat', header=TRUE)
death <- read.table('death1722uk.dat', header=TRUE)

population_m <- info$mpop17
population_f <- info$fpop17
death_m <- info$mm
death_f <- info$mf
modifier <- death$d
```


```{r}
#Q1
predicted_death_week <- function(population_m, population_f, dr_m, dr_f, mod){
  
  q_m <- 1 - exp(-dr_m/52)
  q_f <- 1 - exp(-dr_f/52)
  pop_m <- population_m
  pop_f <- population_f
  death_count_week <- rep(0,length(mod)) 
    
  for (i in 1:length(mod)){
    d <- mod[i] # modifier in week i
    death_m <- d*0.9885*q_m*pop_m
    death_f <- d*0.9885*q_f*pop_f
    death_count_week[i] <- sum(death_m + death_f)
    
    pop_m[1] <- (pop_m[1] - death_m[1])*(51/52)
    pop_f[1] <- (pop_f[1] - death_f[1])*(51/52)
    
    for (i in 2:length(pop_m)){
      pop_m[i] <- (pop_m[i] - death_m[i])*(51/52) + pop_m[i-1]/52
      pop_f[i] <- (pop_f[i] - death_f[i])*(51/52) + pop_f[i-1]/52
    }
    
  }
  
  death_count_week
}

test <- predicted_death_week(population_m, population_f, death_m, death_f, modifier[1:156])
sum(death$deaths[1:156]) - sum(test)
```


```{r}
#Q2
population_m_20 <- info$mpop20
population_f_20 <- info$fpop20

death_from_2020 <- death$deaths[157:length(death$deaths)]
p_death_from_2020 <- predicted_death_week(population_m_20, population_f_20, death_m, death_f, modifier[157:length(death$deaths)])
excess_death_from_2020 <- death_from_2020 - p_death_from_2020
excess_from_2020_sum <- sum(excess_death_from_2020)

death_2020 <- death$deaths[157:208]
p_death_2020 <- predicted_death_week(population_m_20, population_f_20, death_m, death_f, modifier[157:208])
excess_death_2020 <- death_2020 - p_death_2020
excess_2020_sum <- sum(excess_death_2020)
```


```{r}
#Q3
week <- c(1:52)
plot(week, death_2020, col = 'blue', xlab = "weeks", ylab = "number of death")
lines(week, p_death_2020, col = 'red')
legend(x = 'topright', legend=c("observed", "predicted"),
       col=c("blue", "red"), inset = 0.05, lty = 3:1 ,cex=1.2, border = "black",
       box.lty=0, bg = rgb(1, 0, 0, alpha = 0.15))
```


```{r}
#Q4
cum_excess <- cumsum(excess_death_2020)
plot(week, cum_excess, type = "b", pch = 18, col = "red", xlab = "weeks", ylab = "excess death")
```


```{r}
#Q5
library('rjags')
jags_params <- c("mu", "rho", "k")
delete <- c(51, 52, 53, 105, 106)
for (i in delete){
  excess_death_from_2020[i] <- NA
}

jags_data <- list(x = excess_death_from_2020, N = length(excess_death_from_2020))
model_jags <- jags.model("model.jags", data = jags_data)
sample <- jags.samples(model_jags, jags_params, n.iter = 10000, jags.seed = 1)

sample_coda <- coda.samples(model_jags, jags_params, n.iter = 10000, jags.seed = 1)
print(sample)
```


```{r}
#Q6
sample_coda_list <- as.mcmc.list(sample_coda)
rho_list <- sample_coda_list[, length(excess_death_from_2020)+2]
plot(rho_list)
```


```{r}
#Q7
mu <- sample$mu

mu_coda <- rep(0,length(excess_death_from_2020)+2)
for (i in 1:(length(excess_death_from_2020)+2)){
  mu_coda[i]<-sum(unlist(sample_coda_list[,i]))/10000
}
mu_coda <- mu_coda[2:(length(excess_death_from_2020)+1)]
mu_coda
```


```{r}
#Q8
weeks <- rep(1:length(excess_death_from_2020))
index <- seq(50,10000,50)
p_vector <- (sample_coda_list[,2:(length(excess_death_from_2020)+1)])
plot(weeks, )

```


```{r}
#Q9
residual_d <- excess_death_from_2020 - mu_coda
time <- (1:length(excess_death_from_2020))
plot(time, residual_d)
```

